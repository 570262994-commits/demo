{
  "version": "1.0.0",
  "last_updated": "2026-02-10",
  "description": "AC-Insight智能经营分析工作台的语义字典 - 最终封版",

  "indicators": {
    "销售额": {
      "name": "销售额",
      "formula": "SUM(COALESCE(unitPrice * quantity, 0)) / 100.0",
      "fields": ["unitPrice", "quantity"],
      "level": "L0",
      "synonyms": ["营收", "销售金额", "sales_amount", "turnover", "流水", "业绩"],
      "unit": "元",
      "description": "基于订单的销售额，将分转换为元单位展示",
      "calculation": "聚合计算，自动处理NULL值",
      "performance": "直接查询orders表，利用ownerId索引",
      "default_visualization": "card",
      "denial_message": null,
      "dependencies": [],
      "business_rule": "订单确认即确认为销售额"
    },
    "毛利": {
      "name": "毛利",
      "formula": "SUM(COALESCE((unitPrice - costPrice) * quantity, 0)) / 100.0",
      "fields": ["unitPrice", "costPrice", "quantity"],
      "level": "L1",
      "synonyms": ["利润", "盈利", "margin", "profit", "毛收益"],
      "unit": "元",
      "description": "基于订单的毛利，扣除成本后的收益，将分转换为元",
      "calculation": "聚合计算，自动处理NULL值",
      "performance": "直接查询orders表，利用ownerId索引",
      "default_visualization": "line_chart",
      "denial_message": "毛利涉及核心财务数据，需 Admin 权限；建议查询销售额",
      "dependencies": ["costPrice"],
      "business_rule": "毛利 = 销售额 - 成本，L1级敏感指标"
    },
    "实时欠款": {
      "name": "实时欠款",
      "formula": "(SUM(COALESCE(CASE WHEN type='DEBT' THEN amount ELSE 0 END, 0)) - SUM(COALESCE(CASE WHEN type='REPAY' THEN amount ELSE 0 END, 0))) / 100.0",
      "fields": ["amount", "type"],
      "level": "L1",
      "synonyms": ["应收账款", "欠款余额", "应收", "debt", "receivable", "未回款"],
      "unit": "元",
      "description": "客户当前的欠款总额，已还款已扣除，将分转换为元",
      "calculation": "跨表关联计算，自动处理NULL值",
      "performance": "关联customers和finances表，利用ownerId索引",
      "default_visualization": "table",
      "denial_message": "实时欠款涉及核心财务数据，需 Admin 权限；建议查询销售额",
      "dependencies": ["DEBT", "REPAY"],
      "business_rule": "L1级敏感指标，仅Admin可查看"
    },
    "订单数": {
      "name": "订单数",
      "formula": "COUNT(DISTINCT id)",
      "fields": ["id"],
      "level": "L0",
      "synonyms": ["订单数量", "单量", "order_count", "transaction_count"],
      "unit": "个",
      "description": "订单的总数量",
      "calculation": "计数查询，自动处理NULL值",
      "performance": "直接查询orders表，利用ownerId索引",
      "default_visualization": "card",
      "denial_message": null,
      "dependencies": [],
      "business_rule": "基础业务指标，所有用户可访问"
    },
    "客单价": {
      "name": "客单价",
      "formula": "SUM(COALESCE(unitPrice * quantity, 0)) / (NULLIF(COUNT(DISTINCT customerId), 0)) / 100.0",
      "fields": ["unitPrice", "quantity", "customerId"],
      "level": "L0",
      "synonyms": ["平均订单金额", "average_order_value", "AOV"],
      "unit": "元",
      "description": "每个客户的平均订单金额，将分转换为元",
      "calculation": "除法计算，处理除零错误",
      "performance": "聚合orders表，关联customers表",
      "default_visualization": "bar_chart",
      "denial_message": null,
      "dependencies": ["customerId"],
      "business_rule": "客户价值分析指标"
    },
    "回款率": {
      "name": "回款率",
      "formula": "(SUM(COALESCE(CASE WHEN type='REPAY' THEN amount ELSE 0 END, 0)) / NULLIF(SUM(COALESCE(CASE WHEN type='DEBT' THEN amount ELSE 0 END, 0)), 0)) * 100.0",
      "fields": ["amount", "type"],
      "level": "L1",
      "synonyms": ["还款率", "collection_rate", "payment_ratio"],
      "unit": "%",
      "description": "客户回款占欠款的比例，以百分比展示",
      "calculation": "除法计算，处理除零错误，结果*100",
      "performance": "关联finances表，计算还款比例",
      "default_visualization": "progress_chart",
      "denial_message": "回款率涉及核心财务数据，需 Admin 权限；建议查询订单数",
      "dependencies": ["DEBT", "REPAY"],
      "business_rule": "L1级敏感指标，衡量客户还款能力"
    },
    "毛利率": {
      "name": "毛利率",
      "formula": "(SUM(COALESCE((unitPrice - costPrice) * quantity, 0)) / NULLIF(SUM(COALESCE(unitPrice * quantity, 0)), 0)) * 100.0",
      "fields": ["unitPrice", "costPrice", "quantity"],
      "level": "L1",
      "synonyms": ["利润率", "margin_ratio", "profit_margin"],
      "unit": "%",
      "description": "毛销售额的百分比，反映成本控制能力",
      "calculation": "除法计算，处理除零错误，结果*100",
      "performance": "直接查询orders表，利用ownerId索引",
      "default_visualization": "line_chart",
      "denial_message": "毛利率涉及核心财务数据，需 Admin 权限；建议查询销售额",
      "dependencies": ["costPrice"],
      "business_rule": "L1级指标，反映盈利能力"
    },
    "区域销售额": {
      "name": "区域销售额",
      "formula": "SUM(COALESCE(unitPrice * quantity, 0)) / 100.0",
      "fields": ["unitPrice", "quantity", "region"],
      "level": "L0",
      "synonyms": ["地区业绩", "区域营收", "regional_sales"],
      "unit": "元",
      "description": "按区域分组的销售额统计",
      "calculation": "分组聚合计算，自动处理NULL值",
      "performance": "分组查询orders表，关联customers表",
      "default_visualization": "map",
      "denial_message": null,
      "dependencies": ["region"],
      "business_rule": "区域业绩分析指标"
    }
  },

  "dimensions": {
    "时间": {
      "name": "时间",
      "field": "createdAt",
      "table": "orders",
      "formats": {
        "今天": "date('now')",
        "昨天": "date('now', '-1 day')",
        "本周": "date('now', 'weekday 0', '-7 days')",
        "本月": "date('now', 'start of month')",
        "上月": "date('now', 'start of month', '-1 month')",
        "近7天": "date('now', '-7 days')",
        "近30天": "date('now', '-30 days')",
        "近90天": "date('now', '-90 days')",
        "本季度": "date('now', 'start of quarter')",
        "本年度": "date('now', 'start of year')"
      },
      "synonyms": ["时间", "日期", "day", "date", "time"],
      "description": "用于时间维度过滤，支持多种时间范围表达",
      "default_format": "近30天"
    },
    "区域": {
      "name": "区域",
      "field": "region",
      "table": "customers",
      "values": ["全国", "华东", "华北", "华南", "华中", "西南", "西北"],
      "mappings": {
        "华东区": "华东",
        "华北区": "华北",
        "华南区": "华南",
        "华中区": "华中",
        "西南区": "西南",
        "西北区": "西北",
        "东部": "华东",
        "北部": "华北",
        "南部": "华南",
        "中部": "华中",
        "西部": ["西南", "西北"]
      },
      "synonyms": ["区域", "大区", "省份", "region", "area", "province"],
      "description": "客户所在区域，支持多级映射",
      "default_value": "全国"
    },
    "客户名称": {
      "name": "客户名称",
      "field": "name",
      "table": "customers",
      "mappings": {
        "公司": "name",
        "客户": "name",
        "抬头": "name",
        "客户名称": "name",
        "企业名称": "name"
      },
      "synonyms": ["公司", "客户", "抬头", "客户名称", "企业名称", "customer_name"],
      "description": "客户的公司名称，支持多种称呼",
      "default_value": "all"
    },
    "产品": {
      "name": "产品",
      "field": "productName",
      "table": "orders",
      "synonyms": ["产品", "商品", "货物", "product", "item", "goods"],
      "description": "订购的产品名称",
      "default_value": "all"
    },
    "状态": {
      "name": "状态",
      "field": "type",
      "table": "finances",
      "values": ["DEBT", "REPAY"],
      "mappings": {
        "欠款": "DEBT",
        "还款": "REPAY",
        "应收": "DEBT",
        "实收": "REPAY",
        "债务": "DEBT",
        "支付": "REPAY"
      },
      "synonyms": ["类型", "状态", "transaction_type", "payment_type"],
      "description": "财务交易类型",
      "default_value": "all"
    }
  },

  "rules": {
    "calculation": {
      "null_handling": {
        "requirement": "所有聚合查询必须使用COALESCE处理NULL值",
        "function": "COALESCE(field, 0)",
        "mandatory": true
      },
      "unit_conversion": {
        "requirement": "所有金额相关指标必须将分转换为元",
        "formula": "金额（分） / 100.0",
        "precision": "浮点数除法",
        "mandatory": true
      },
      "aggregation": {
        "requirement": "所有计算必须使用预定义的聚合函数",
        "allowed_functions": ["SUM", "COUNT", "AVG", "MAX", "MIN"],
        "forbidden": ["自定义计算", "直接访问原始字段"]
      }
    },

    "security": {
      "access_control": {
        "L0": "所有用户可访问",
        "L1": "仅Admin可访问",
        "row_filter": "所有查询自动添加owner_id过滤条件"
      },
      "denial_templates": {
        "L1": "[指标名]涉及核心财务数据，需 Admin 权限；建议查询[替代指标]"
      },
      "injection_prevention": {
        "rule": "禁止用户直接操作owner_id字段",
        "validation": "所有owner_id值必须来自x-user-id header"
      }
    },

    "performance": {
      "index_strategy": {
        "primary": ["ownerId", "createdAt", "region"],
        "composite": ["ownerId + region", "ownerId + createdAt"]
      },
      "join_optimization": {
        "strategy": "优先使用ownerId进行关联",
        "avoid": "避免全表扫描"
      },
      "cache_policy": {
        "dictionary": "语义字典缓存，有效期5分钟",
        "query": "查询结果缓存，有效期2分钟",
        "aggregate": "聚合结果缓存，有效期10分钟"
      }
    }
  },

  "query_rules": {
    "default_time_range": "last_30_days",
    "max_records": 1000,
    "timeout_seconds": 30,
    "allowed_operations": {
      "aggregation": ["SUM", "COUNT", "AVG", "GROUP BY"],
      "filtering": ["WHERE", "HAVING"],
      "sorting": ["ORDER BY"]
    },
    "forbidden_operations": {
      "sql_injection": ["; DROP", "--", "/*", "xp_"],
      "system_access": ["sys.tables", "information_schema"],
      "unauthorized_access": ["owner_id"]
    }
  },

  "visualization": {
    "default_types": {
      "card": ["销售额", "订单数", "客单价"],
      "line_chart": ["毛利", "毛利率"],
      "bar_chart": ["客单价", "区域销售额"],
      "table": ["实时欠款", "客户排名"],
      "map": ["区域销售额"],
      "progress_chart": ["回款率"]
    },
    "color_scheme": {
      "primary": "#3B82F6",
      "secondary": "#10B981",
      "warning": "#F59E0B",
      "danger": "#EF4444"
    }
  },

  "metadata": {
    "creation_date": "2024-01-20",
    "finalized_date": "2026-02-10",
    "status": "DONE",
    "reviewer": "Claude AI Assistant",
    "security_level": "Enterprise",
    "compliance": ["SOX", "GDPR", "数据安全法"]
  }
}