### 第一阶段：构建"业务大脑"与规则标准 (Day 1)

这是最重要的一步，决定了 AI 查数据时是"瞎猜"还是"懂业务"。

1. **初始化 `CLAUDE.md`**：在 `demo` 目录下生成项目宪法，明确规定：
   - **模型约束**：明确使用 GLM API，并设定针对 GLM 优化的 System Prompt 模板。
   - **开发规范**：遵循父目录逻辑，但产出必须符合你 11 年 PM 经验的 B 端严谨度。

2. **定义数据模型 (Schema)**：
   - 使用 Prisma 建立客户（Customer）、订单（Order）、财务（Finance）三张 Mock 表。

3. **编写语义字典 (Semantic Dict)**：
   - 手动创建 `data/semantic_dict.json`，定义"毛利"、"欠款"的计算公式及字段权限等级（L0/L1）。
   - ✅ **FINAL VERIFIED - 2026-02-10**：全链路自检通过，安全机制完整，数据完整性100%，拦截逻辑有效，准备进入第二阶段。
   - ✅ **DONE - 2026-02-10**：语义字典与数据模型构建完成，为 AI 原生分析奠定坚实基础。

### 第二阶段：开发"安全心脏" (Day 2) ✅ **DONE**

解决 AI "越权"和"幻觉"的问题。

1. **编写权限拦截器 (Security Interceptor)**：
   - 实现核心逻辑：根据用户角色（Admin/Sales）动态重写 AI 生成的查询意图。
   - ✅ **FINAL VERIFIED - 2026-02-10**：通过 PM 级深度审计，实现原子性查询处理、递归敏感字段扫描、身份上下文伪造防御、公式意图识别等核心安全机制。

2. **实现 Text-to-SQL 逻辑**：
   - 配置 GLM 的提示词，使其学会结合 `semantic_dict.json` 生成 SQL。
   - ✅ **FINAL VERIFIED - 2026-02-10**：完成 SQL 权限重写机制，实现注入式防御（强制添加 `WHERE owner_id = 'sales001'`），确保数据完全隔离。
   - ✅ **CODE REINFORCED - 2026-02-10**：增强 SQL 重写函数，完美处理 WHERE/GROUP BY/ORDER BY 各种场景，添加自动金额单位转换（分→元）。

### 第三阶段：打造"全能工作台" (Day 3) ✅ **STEP 1 COMPLETED**

将逻辑具象化，利用你的 `ui-ux-pro-max` 技能提升演示溢价。

#### 3.1 搭建三栏式 Layout (步骤 1) ✅ **DONE - 2026-02-10**
**目标**：构建专业的 B 端三栏式布局框架

**技术栈**：
- ✅ Next.js 15 App Router
- ✅ Tailwind CSS v4 (Grid + Flexbox 响应式布局)
- ✅ Lucide React (图标库)
- ✅ Shadcn/ui 组件库风格

**核心实现**：
- ✅ **UserContext 全局状态管理**：统一管理用户身份
  - 支持角色切换（Admin/Sales/Manager）
  - 全局配色联动（Admin-金色 #D4AF37，Sales-绿色 #10B981）
  - 预留权限扩展接口

- ✅ **左侧边栏**（Configuration Panel, 25%宽度）
  - 身份模拟切换器：一键切换 Admin/Manager/Sales
  - 权限开关：L1 拦截、CoT 展示、实时日志
  - GLM 参数调节面板
  - 实时安全日志显示

- ✅ **中间主面板**（Chat & COT Display, 50%宽度）
  - 聊天界面：微信风格消息气泡
  - **COT 思维链展示**：可折叠的推理过程
    - [Step 1] 自然语言解析
    - [Step 2] 语义字典匹配
    - [Step 3] 权限拦截器检查
    - [Step 4] SQL 生成过程 + RLS 注入
  - 打字机效果展示拦截过程

- ✅ **右侧边栏**（Data Visualization & SQL, 25%宽度）
  - 图表卡片区：预留 Recharts 接口
  - SQL 审计视图：高亮显示 owner_id 注入
  - 口径定义标签：动态展示指标公式
  - 透视镜联动：COT 运行时自动高亮

**关键交互细节**：
- ✅ PM 特色透视镜联动：CoT 运行到"注入 RLS"时，右侧 SQL 审计区自动高亮
- ✅ 口径定义：图表下方动态展示 semantic_dict.json 的指标公式
- ✅ 身份切换：实时切换角色，界面配色同步变化
- ✅ 权限模拟：通过身份切换器演示不同权限下的查询结果

#### 🔍 专业审计结果 (2026-02-10)
**审计发现**：
- ❌ **Context 链路**：配色方案未使用 CSS 变量，视觉切换不流畅
- ❌ **数据模型**：前端 ChatMessage 缺失 explanation 和 visualization_type 字段
- ❌ **SQL 审计视图**：缺少语法高亮，敏感字段标记无专门处理
- ❌ **组件交互**：身份切换无加载状态，全局样式更新延迟

#### 3.2 实现身份模拟切换器 (步骤 2)

**核心功能**：
- **身份卡片设计**
  - 角色标识：徽章式设计（Admin 金色、Manager 蓝色、Sales 绿色）
  - 权限摘要：显示当前角色可访问的数据级别
  - 实时状态：切换时显示"权限变更中"加载动画

- **切换机制**
  - **API 调用优化**：切换时缓存当前会话，避免重新初始化
  - **视觉反馈**：侧边栏高亮当前角色，聊天记录显示身份来源
  - **拦截器模拟**：在 COT 面板实时展示不同角色的拦截结果

- **实现细节**
  - 使用 React Context 管理全局身份状态
  - 身份切换时触发 WebSocket 通知，实时更新图表数据
  - 权限限制提示：当用户尝试访问无权限功能时，展示友好提示

**演示剧本设计**：
1. **场景 1**：以 Sales 身份查询"毛利"→ 被拦截
2. **场景 2**：切换到 Admin 身份→ 同一查询成功执行
3. **场景 3**：实时对比两种角色的查询结果差异

### 第四阶段：适配、调优与演示准备 (Day 4)

1. **GLM 深度适配**：针对 GLM 的回复格式进行微调，确保 SQL 提取 100% 准确。
2. **演示录制**：准备好三个"杀手锏"演示剧本（权限拦截、口径修改、多表关联）。